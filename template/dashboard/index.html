

{% extends 'dashboard/base.html' %}

{% block title %}
Dashboard
{% endblock title %}

{% block content %}

<!--app-content open-->
<div class="app-content">
	<div class="side-app">

		<!-- Active Notices -->
		{% if active_notices %}
			{% for notice in active_notices %}
				<div class="alert alert-danger text-center mb-3" style="background-color: #dc3545; color: white; border: none; border-radius: 8px; margin: 15px 0; padding: 15px 20px; font-weight: 500; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);">
					<div style="color: white; line-height: 1.5;">{{ notice.content|linebreaks }}</div>
				</div>
			{% endfor %}
		{% endif %}

		<div class="page-header">
			<div>
				<h1 class="page-title">Dashboard</h1>
				<ol class="breadcrumb">
					<li class="breadcrumb-item active" aria-current="page">Performance Overview</li>
				</ol>
			</div>
			<div class="ms-auto pageheader-btn">
				<div class="row">
					<div class="col-lg-6 col-md-12 col-sm-12">
						<div class="input-group">
							<input type="text" class="form-control" id="dateRange" placeholder="Today" readonly style="background-color: white !important;">
						</div>
						<input type="hidden" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}">
						<input type="hidden" id="end_date" name="end_date" value="{{ end_date|date:'Y-m-d' }}">
					</div>
				</div>
			</div>
		</div>

		<!-- ROW-1 -->
		<div class="row">
			<div class="col-lg-12 col-md-12 col-sm-12 col-xl-12">
				<!-- Balance and Total Paid Cards Row -->
				<div class="row mb-3">
					<div class="col-lg-6 col-md-12 col-sm-12 col-xl-6">
						<div class="card overflow-hidden">
							<div class="card-body">
								<div class="row">
									<div class="col">
										<h6 class="">Balance</h6>
										<h3 class="mb-2 number-font">${{ user.balance|floatformat:2 }}</h3>
										<p class="text-muted mb-0">
											<span class="text-success"><i class="fa fa-wallet text-success me-1"></i></span>
											Available Balance
										</p>
									</div>
									<div class="col col-auto">
										<div class="counter-icon bg-success-gradient box-shadow-success brround ms-auto">
											<i class="fe fe-dollar-sign text-white mb-5 "></i>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-lg-6 col-md-12 col-sm-12 col-xl-6">
						<div class="card overflow-hidden">
							<div class="card-body">
								<div class="row">
									<div class="col">
										<h6 class="">Total Paid</h6>
										<h3 class="mb-2 number-font">${{ total_paid|floatformat:2|default:"0.00" }}</h3>
										<p class="text-muted mb-0">
											<span class="text-info"><i class="fa fa-credit-card text-info me-1"></i></span>
											Total Money Paid
										</p>
									</div>
									<div class="col col-auto">
										<div class="counter-icon bg-info-gradient box-shadow-info brround ms-auto">
											<i class="fe fe-credit-card text-white mb-5 "></i>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- End Balance and Total Paid Cards Row -->
				
				<!-- Performance Metrics Cards Row -->
				<div class="row">
					<div class="col-lg-6 col-md-12 col-sm-12 col-xl-3">
						<div class="card overflow-hidden">
							<div class="card-body">
								<div class="row">
									<div class="col">
										<h6 class="">Clicks</h6>
										<h3 class="mb-2 number-font" id="totalClicks">{{ total_clicks|default:0 }}</h3>
									</div>
									<div class="col col-auto">
										<div class="counter-icon bg-primary-gradient box-shadow-primary brround ms-auto">
											<i class="fa fa-mouse-pointer text-white mb-5"></i>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-lg-6 col-md-12 col-sm-12 col-xl-3">
						<div class="card overflow-hidden">
							<div class="card-body">
								<div class="row">
									<div class="col">
										<h6 class="">Conversion</h6>
										<h3 class="mb-2 number-font" id="totalConversions">{{ total_conversions|default:0 }}</h3>
									</div>
									<div class="col col-auto">
										<div class="counter-icon bg-success-gradient box-shadow-success brround ms-auto">
											<i class="fa fa-check-circle text-white mb-5"></i>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-lg-6 col-md-12 col-sm-12 col-xl-3">
						<div class="card overflow-hidden">
							<div class="card-body">
								<div class="row">
									<div class="col">
										<h6 class="">Earnings</h6>
										<h3 class="mb-2 number-font" id="totalEarnings">${{ total_earnings|floatformat:2|default:"0.00" }}</h3>
									</div>
									<div class="col col-auto">
										<div class="counter-icon bg-warning-gradient box-shadow-warning brround ms-auto">
											<i class="fa fa-dollar-sign text-white mb-5"></i>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-lg-6 col-md-12 col-sm-12 col-xl-3">
						<div class="card overflow-hidden">
							<div class="card-body">
								<div class="row">
									<div class="col">
										<h6 class="">Conversion Rate</h6>
										<h3 class="mb-2 number-font" id="conversionRate">{{ conversion_rate|floatformat:2 }}%</h3>
									</div>
									<div class="col col-auto">
										<div class="counter-icon bg-info-gradient box-shadow-info brround ms-auto">
											<i class="fa fa-percent text-white mb-5"></i>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- End Performance Metrics Cards Row -->
			</div>
		</div>
		<div class="row">
			<div class="col-sm-12 col-md-12 col-lg-12 col-xl-9">
				<div class="card">
					<div class="card-header">
						<h3 class="card-title">Clicks vs Leads</h3>
					</div>
					<div class="card-body pb-0">
						                    <div style="height: 400px; position: relative;">
                        <canvas id="clicksVsLeadsChart" width="400" height="400"></canvas>
                    </div>
					</div>
				</div>
			</div><!-- COL END -->
			<div class="col-sm-12 col-md-12 col-lg-12 col-xl-3">
				<div class="card custom-card ">
					<div class="card-header text-center">
						<h3 class="card-title">EPC</h3>
					</div>
					<div class="card-body pt-0">
						<div class="text-center mb-4 mt-3">
							<h2 class="mb-0 fw-bold text-primary">
								{% if total_clicks > 0 %}
									${{ total_earnings|default:0|floatformat:2 }}
								{% else %}
									$0.00
								{% endif %}
							</h2>
							<p class="text-muted mb-0">Earnings Per Click</p>
						</div>
						<div class="row sales-product-infomation pb-0 mb-0 mx-auto wd-100p mt-6">
							<div class="col-md-6 col justify-content-center text-center">
								<p class="mb-0 d-flex justify-content-center"><span class="legend bg-success"></span>Clicks</p>
								<h3 class="mb-1 fw-bold">{{ total_clicks }}</h3>
								<div class="d-flex justify-content-center ">
									<p class="text-muted mb-0">Total Clicks</p>
								</div>
							</div>
							<div class="col-md-6 col text-center float-end">
								<p class="mb-0 d-flex justify-content-center "><span class="legend bg-info"></span>Leads</p>
								<h3 class="mb-1 fw-bold">{{ total_conversions }}</h3>
								<div class="d-flex justify-content-center ">
									<p class="text-muted mb-0">Total Leads</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div><!-- COL END -->
		</div>
		<!-- ROW-1 END -->

		<!-- ROW-5 -->
		<div class="row">
			<div class="col-12 col-sm-12">
				<div class="card ">
					<div class="card-header">
						<h3 class="card-title mb-0">Latest Offers</h3>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table id="data-table" class="table table-bordered text-nowrap mb-0">
								<thead class="border-top">
								<tr>
									<th class="bg-transparent border-bottom-0 w-5">S.no</th>
									<th class="bg-transparent border-bottom-0">Offer Name</th>
									<th class="bg-transparent border-bottom-0">Payout</th>
									<th class="bg-transparent border-bottom-0">EPC</th>
									<th class="bg-transparent border-bottom-0">Countries</th>
									<th class="bg-transparent border-bottom-0">Devices</th>
									<th class="bg-transparent border-bottom-0">Action</th>
								</tr>
								</thead>
								<tbody>
									{% if latest_offers %}
										{% for offer in latest_offers %}
											<tr class="border-bottom">
												<td class="text-muted fs-15 fw-semibold text-center">{{ forloop.counter }}.</td>
												<td>
													<div class="d-flex">
														{% if offer.offer_image %}
															<span class="avatar avatar-md brround mt-1" style="background-image: url({{ offer.offer_image.url }})"></span>
														{% else %}
															<span class="avatar avatar-md brround mt-1" style="background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
																<i class="fa fa-image text-muted" style="font-size: 20px;"></i>
															</span>
														{% endif %}
														<div class="ms-2 mt-0 mt-sm-2 d-block">
															<h6 class="mb-0 fs-14 fw-semibold">{{ offer.offer_name|truncatechars:30 }}</h6>
															<span class="fs-12 text-muted">Cpa Offer</span>
														</div>
													</div>
												</td>
												<td class="text-muted fs-15 fw-semibold">${{ offer.payout|floatformat:2 }}</td>
												<td class="text-muted fs-15 fw-semibold">
													{% if offer.epc %}
														${{ offer.epc|floatformat:2 }}
													{% else %}
														$0.00
													{% endif %}
												</td>
												<td class="text-muted fs-15 fw-semibold">
													{% if offer.countries %}
														{% if offer.countries|length > 0 %}
															{% for country in offer.countries|slice:":2" %}
																<span class="badge badge-black me-1">{{ country }}</span>
															{% endfor %}
															{% if offer.countries|length > 2 %}
																<span class="badge badge-black">+{{ offer.countries|length|add:"-2" }}</span>
															{% endif %}
														{% else %}
															<span class="text-muted">-</span>
														{% endif %}
													{% else %}
														<span class="text-muted">-</span>
													{% endif %}
												</td>
												<td class="text-muted fs-15 fw-semibold">
													{% if offer.devices %}
														{% if offer.devices|length > 0 %}
															{% for device in offer.devices %}
																<span class="badge badge-black me-1">{{ device|title }}</span>
															{% endfor %}
														{% else %}
															<span class="text-muted">-</span>
														{% endif %}
													{% else %}
														<span class="text-muted">-</span>
													{% endif %}
												</td>
												<td class="">
													<a href="{% url 'view_offer' offer.id %}" class="btn btn-primary btn-sm rounded-11" data-bs-toggle="tooltip" data-bs-original-title="View Offer Details">
														<i class="fa fa-eye"></i>
													</a>
												</td>
											</tr>
										{% endfor %}
									{% else %}
										<tr>
											<td colspan="7" class="text-center text-muted py-4">
												No offers available.
											</td>
										</tr>
									{% endif %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div><!-- COL END -->
		</div><!-- ROW-5 END -->
	</div>
</div>

{% endblock content %}

{% block page_scripts %}
<style>
/* Custom styling for daterangepicker */
.daterangepicker {
    background-color: white !important;
    border: 1px solid #ddd !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

.daterangepicker .ranges li {
    background-color: white !important;
    color: #333 !important;
}

.daterangepicker .ranges li:hover {
    background-color: #f8f9fa !important;
}

.daterangepicker .ranges li.active {
    background-color: #007bff !important;
    color: white !important;
}

.daterangepicker .calendar-table {
    background-color: white !important;
}

.daterangepicker .drp-buttons {
    background-color: white !important;
    border-top: 1px solid #ddd !important;
}

.daterangepicker .drp-selected {
    color: #333 !important;
}

.daterangepicker .calendar-table .next span, 
.daterangepicker .calendar-table .prev span {
    border-color: #333 !important;
}

.daterangepicker .calendar-table .next:hover span, 
.daterangepicker .calendar-table .prev:hover span {
    background-color: #f8f9fa !important;
}

/* Fix daterangepicker positioning and display issues */
.daterangepicker {
    z-index: 9999 !important;
    position: absolute !important;
    max-width: none !important;
    overflow: visible !important;
}

.daterangepicker .ranges {
    float: left !important;
    width: auto !important;
    min-width: 160px !important;
}

.daterangepicker .drp-calendar {
    float: left !important;
    width: auto !important;
    min-width: 200px !important;
}

.daterangepicker .drp-buttons {
    clear: both !important;
    width: 100% !important;
}

/* Ensure the daterangepicker doesn't get cut off */
.daterangepicker.drops-auto {
    position: absolute !important;
}

.daterangepicker.drops-up {
    position: absolute !important;
}

.daterangepicker.drops-down {
    position: absolute !important;
}

/* Ensure date input has full white background */
#dateRange {
    background-color: white !important;
    border: 1px solid #ddd !important;
}

#dateRange:focus {
    background-color: white !important;
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

/* Adjust card spacing after removing subheadlines */
.card-body .row .col h3 {
    margin-bottom: 0.5rem !important;
}

/* Black badge styling for countries and devices */
.badge-black {
    background-color: #000 !important;
    color: white !important;
}

.badge-black:hover {
    background-color: #333 !important;
    color: white !important;
}
</style>
<script>
// Simple daterangepicker initialization as per click_report.html
function initializeDaterangepicker() {
    if (typeof $ !== 'undefined' && typeof $.fn.daterangepicker !== 'undefined') {
        $('#dateRange').daterangepicker({
            startDate: moment(),
            endDate: moment(),
            ranges: {
               'Today': [moment(), moment()],
               'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
               'Last 7 Days': [moment().subtract(6, 'days'), moment()],
               'Last 30 Days': [moment().subtract(29, 'days'), moment()],
               'This Month': [moment().startOf('month'), moment().endOf('month')],
               'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            },
            locale: {
                format: 'MM/DD/YYYY'
            },
            autoApply: true,
            showDropdowns: true,
            showCustomRangeLabel: true,
            alwaysShowCalendars: true,
            opens: 'center',
            drops: 'auto'
        }, function(start, end, label) {
            // Update hidden inputs
            $('#start_date').val(start.format('YYYY-MM-DD'));
            $('#end_date').val(end.format('YYYY-MM-DD'));
            
            // Apply filters immediately
            applyFilters();
        });
        
        // Set current filter values if they exist
        {% if start_date and end_date %}
        var startDate = '{{ start_date|date:"Y-m-d" }}';
        var endDate = '{{ end_date|date:"Y-m-d" }}';
        $('#start_date').val(startDate);
        $('#end_date').val(endDate);
        
        // Set the daterangepicker to current values
        $('#dateRange').data('daterangepicker').setStartDate(moment(startDate));
        $('#dateRange').data('daterangepicker').setEndDate(moment(endDate));
        $('#dateRange').val('Today');
        {% else %}
        // Set default values to today
        var startDate = moment().format('YYYY-MM-DD');
        var endDate = moment().format('YYYY-MM-DD');
        $('#start_date').val(startDate);
        $('#end_date').val(endDate);
        $('#dateRange').val('Today');
        {% endif %}
    } else {
        // Retry after a short delay if jQuery or daterangepicker not ready
        setTimeout(initializeDaterangepicker, 100);
    }
}

// Initialize when document is ready
$(document).ready(function() {
    initializeDaterangepicker();
    initializeClicksVsLeadsChart();
});

// Apply filters - redirect with date parameters
function applyFilters() {
    const startDate = $('#start_date').val();
    const endDate = $('#end_date').val();
    
    // Build query parameters
    const params = new URLSearchParams();
    
    if (startDate && endDate) {
        params.append('start_date', startDate);
        params.append('end_date', endDate);
    }
    
    // Redirect with filters
    window.location.href = `{% url 'dashboard' %}?${params.toString()}`;
}

// Initialize Clicks vs Leads Chart
function initializeClicksVsLeadsChart() {
    const ctx = document.getElementById('clicksVsLeadsChart');
    if (!ctx) {
        return;
    }
    
    // Get chart data from Django context
    const chartData = {{ chart_data|safe }};
    
    if (chartData && chartData.length > 0) {
        const labels = chartData.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
        });
        
        const clicksData = chartData.map(item => item.clicks);
        const leadsData = chartData.map(item => item.leads);
        
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Leads',
                        data: leadsData,
                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Clicks',
                        data: clicksData,
                        backgroundColor: 'rgba(0, 123, 255, 0.8)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Count'
                        },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    } else {
        // Show message if no data
        ctx.style.height = '200px';
        ctx.style.display = 'flex';
        ctx.style.alignItems = 'center';
        ctx.style.justifyContent = 'center';
        ctx.style.fontSize = '16px';
        ctx.style.color = '#6c757d';
        ctx.innerHTML = 'No data available for the selected date range';
    }
}
</script>
{% endblock %}